{"version":3,"file":"age-assurance.test.js","sourceRoot":"","sources":["../src/age-assurance.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it } from '@jest/globals'\nimport {\n  ageAssuranceRuleIDs,\n  computeAgeAssuranceRegionAccess,\n  getAgeAssuranceRegionConfig,\n} from './age-assurance'\nimport { AppBskyAgeassuranceDefs } from './client'\n\ndescribe('age-assurance', () => {\n  describe('getAgeAssuranceRegionConfig', () => {\n    const config: AppBskyAgeassuranceDefs.Config = {\n      regions: [\n        {\n          countryCode: 'US',\n          regionCode: 'CA',\n          rules: [],\n        },\n        {\n          countryCode: 'US',\n          rules: [],\n        },\n      ],\n    }\n\n    it('should find region by country code only', () => {\n      const result = getAgeAssuranceRegionConfig(config, {\n        countryCode: 'US',\n      })\n\n      expect(result).toEqual({\n        countryCode: 'US',\n        rules: [],\n      })\n    })\n\n    it('should find region by country code and region code', () => {\n      const result = getAgeAssuranceRegionConfig(config, {\n        countryCode: 'US',\n        regionCode: 'CA',\n      })\n\n      expect(result).toEqual({\n        countryCode: 'US',\n        regionCode: 'CA',\n        rules: [],\n      })\n    })\n\n    it('should return undefined when no matching region found', () => {\n      const result = getAgeAssuranceRegionConfig(config, {\n        countryCode: 'GB',\n      })\n\n      expect(result).toBeUndefined()\n    })\n  })\n\n  describe('computeAgeAssuranceRegionAccess', () => {\n    const region: AppBskyAgeassuranceDefs.ConfigRegion = {\n      countryCode: 'US',\n      rules: [\n        {\n          $type: ageAssuranceRuleIDs.IfAccountNewerThan,\n          date: '2025-12-10T00:00:00Z',\n          access: 'none',\n        },\n        {\n          $type: ageAssuranceRuleIDs.IfAssuredOverAge,\n          age: 18,\n          access: 'full',\n        },\n        {\n          $type: ageAssuranceRuleIDs.IfAssuredOverAge,\n          age: 16,\n          access: 'safe',\n        },\n        {\n          $type: ageAssuranceRuleIDs.IfDeclaredOverAge,\n          age: 16,\n          access: 'safe',\n        },\n        {\n          $type: ageAssuranceRuleIDs.Default,\n          access: 'none',\n        },\n      ],\n    }\n\n    it('should apply default if no data provided', () => {\n      const result = computeAgeAssuranceRegionAccess(region, {})\n\n      expect(result).toEqual({\n        access: 'none',\n        reason: ageAssuranceRuleIDs.Default,\n      })\n    })\n\n    describe('IfAccountNewerThan', () => {\n      it('should block accounts created after threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          accountCreatedAt: new Date(2025, 11, 15).toISOString(),\n          declaredAge: 18,\n        })\n        expect(result).toEqual({\n          access: 'none',\n          reason: ageAssuranceRuleIDs.IfAccountNewerThan,\n        })\n      })\n\n      it('should allow accounts created before threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          accountCreatedAt: new Date(2025, 10, 1).toISOString(),\n          declaredAge: 18,\n        })\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfDeclaredOverAge,\n        })\n      })\n\n      it('should allow accounts created exactly at threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          accountCreatedAt: new Date(2025, 11, 1).toISOString(),\n          declaredAge: 18,\n        })\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfDeclaredOverAge,\n        })\n      })\n\n      it('should not apply rule when accountCreatedAt is not provided', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          declaredAge: 15,\n        })\n        expect(result).toEqual({\n          access: 'none',\n          reason: ageAssuranceRuleIDs.Default,\n        })\n      })\n\n      it('should not apply rule when assuredAge is present', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          accountCreatedAt: new Date(2025, 11, 15).toISOString(),\n          assuredAge: 20,\n        })\n        expect(result).toEqual({\n          access: 'full',\n          reason: ageAssuranceRuleIDs.IfAssuredOverAge,\n        })\n      })\n    })\n\n    describe('IfDeclaredOverAge rule', () => {\n      it('should allow users at or above age threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          declaredAge: 18,\n        })\n\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfDeclaredOverAge,\n        })\n      })\n\n      it('should allow users above age threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          declaredAge: 25,\n        })\n\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfDeclaredOverAge,\n        })\n      })\n\n      it('should not allow users below age threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          declaredAge: 17,\n        })\n\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfDeclaredOverAge,\n        })\n      })\n    })\n\n    describe('IfAssuredOverAge rule', () => {\n      it('should allow users at or above assured age threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          assuredAge: 18,\n        })\n\n        expect(result).toEqual({\n          access: 'full',\n          reason: ageAssuranceRuleIDs.IfAssuredOverAge,\n        })\n      })\n\n      it('should not allow users below assured age threshold', () => {\n        const result = computeAgeAssuranceRegionAccess(region, {\n          assuredAge: 17,\n        })\n\n        expect(result).toEqual({\n          access: 'safe',\n          reason: ageAssuranceRuleIDs.IfAssuredOverAge,\n        })\n      })\n    })\n  })\n})\n"]}