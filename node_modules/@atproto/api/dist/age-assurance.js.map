{"version":3,"file":"age-assurance.js","sourceRoot":"","sources":["../src/age-assurance.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppBskyAgeassuranceDefs } from './client'\nimport { ids } from './client/lexicons'\n\nexport type AgeAssuranceRuleID = Exclude<\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleDefault['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfDeclaredOverAge['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfDeclaredUnderAge['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfAssuredOverAge['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfAssuredUnderAge['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfAccountNewerThan['$type']\n  | AppBskyAgeassuranceDefs.ConfigRegionRuleIfAccountOlderThan['$type'],\n  undefined\n>\n\nexport const ageAssuranceRuleIDs: Record<string, AgeAssuranceRuleID> = {\n  Default: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleDefault`,\n  IfDeclaredOverAge: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfDeclaredOverAge`,\n  IfDeclaredUnderAge: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfDeclaredUnderAge`,\n  IfAssuredOverAge: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfAssuredOverAge`,\n  IfAssuredUnderAge: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfAssuredUnderAge`,\n  IfAccountNewerThan: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfAccountNewerThan`,\n  IfAccountOlderThan: `${ids.AppBskyAgeassuranceDefs}#configRegionRuleIfAccountOlderThan`,\n}\n\n/**\n * Returns the first matched region configuration based on the provided geolocation.\n */\nexport function getAgeAssuranceRegionConfig(\n  config: AppBskyAgeassuranceDefs.Config,\n  geolocation: {\n    countryCode: string\n    regionCode?: string\n  },\n): AppBskyAgeassuranceDefs.ConfigRegion | undefined {\n  const { regions } = config\n  return regions.find(({ countryCode, regionCode }) => {\n    if (countryCode === geolocation.countryCode) {\n      return !regionCode || regionCode === geolocation.regionCode\n    }\n  })\n}\n\nexport function computeAgeAssuranceRegionAccess(\n  region: AppBskyAgeassuranceDefs.ConfigRegion,\n  data:\n    | {\n        /**\n         * The account creation date in ISO 8601 format. Only checked if we\n         * don't have an assured age, such as on the client.\n         */\n        accountCreatedAt?: string\n        /**\n         * The user's declared age\n         */\n        declaredAge?: number\n        /**\n         * The user's minimum age as assured by a trusted third party.\n         */\n        assuredAge?: number\n      }\n    | undefined,\n):\n  | {\n      access: AppBskyAgeassuranceDefs.Access\n      reason: AgeAssuranceRuleID\n    }\n  | undefined {\n  // first match wins\n  for (const rule of region.rules) {\n    if (AppBskyAgeassuranceDefs.isConfigRegionRuleIfAccountNewerThan(rule)) {\n      if (data?.accountCreatedAt && !data?.assuredAge) {\n        const accountCreatedAt = new Date(data.accountCreatedAt)\n        const threshold = new Date(rule.date)\n        if (accountCreatedAt >= threshold) {\n          return {\n            access: rule.access,\n            reason: rule.$type,\n          }\n        }\n      }\n    } else if (\n      AppBskyAgeassuranceDefs.isConfigRegionRuleIfAccountOlderThan(rule)\n    ) {\n      if (data?.accountCreatedAt && !data?.assuredAge) {\n        const accountCreatedAt = new Date(data.accountCreatedAt)\n        const threshold = new Date(rule.date)\n        if (accountCreatedAt < threshold) {\n          return {\n            access: rule.access,\n            reason: rule.$type,\n          }\n        }\n      }\n    } else if (\n      AppBskyAgeassuranceDefs.isConfigRegionRuleIfDeclaredOverAge(rule)\n    ) {\n      if (data?.declaredAge !== undefined && data.declaredAge >= rule.age) {\n        return {\n          access: rule.access,\n          reason: rule.$type,\n        }\n      }\n    } else if (\n      AppBskyAgeassuranceDefs.isConfigRegionRuleIfDeclaredUnderAge(rule)\n    ) {\n      if (data?.declaredAge !== undefined && data.declaredAge < rule.age) {\n        return {\n          access: rule.access,\n          reason: rule.$type,\n        }\n      }\n    } else if (\n      AppBskyAgeassuranceDefs.isConfigRegionRuleIfAssuredOverAge(rule)\n    ) {\n      if (data?.assuredAge && data.assuredAge >= rule.age) {\n        return {\n          access: rule.access,\n          reason: rule.$type,\n        }\n      }\n    } else if (\n      AppBskyAgeassuranceDefs.isConfigRegionRuleIfAssuredUnderAge(rule)\n    ) {\n      if (data?.assuredAge && data.assuredAge < rule.age) {\n        return {\n          access: rule.access,\n          reason: rule.$type,\n        }\n      }\n    } else if (AppBskyAgeassuranceDefs.isConfigRegionRuleDefault(rule)) {\n      return {\n        access: rule.access,\n        reason: rule.$type,\n      }\n    }\n  }\n}\n"]}