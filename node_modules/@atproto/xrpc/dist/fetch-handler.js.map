{"version":3,"file":"fetch-handler.js","sourceRoot":"","sources":["../src/fetch-handler.ts"],"names":[],"mappings":";;AAuDA,8CAkCC;AAxFD,iCAAuC;AAsDvC,SAAgB,iBAAiB,CAC/B,OAAgE;IAEhE,oDAAoD;IACpD,IAAI,OAAO,OAAO,KAAK,UAAU;QAAE,OAAO,OAAO,CAAA;IACjD,IAAI,OAAO,OAAO,KAAK,QAAQ,IAAI,cAAc,IAAI,OAAO,EAAE,CAAC;QAC7D,OAAO,OAAO,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;IAC3C,CAAC;IAED,MAAM,EACJ,OAAO,EACP,OAAO,EAAE,cAAc,GAAG,SAAS,EACnC,KAAK,GAAG,UAAU,CAAC,KAAK,GACzB,GAAG,OAAO,OAAO,KAAK,QAAQ,IAAI,OAAO,YAAY,GAAG;QACvD,CAAC,CAAC,EAAE,OAAO,EAAE,OAAO,EAAE;QACtB,CAAC,CAAC,OAAO,CAAA;IAEX,IAAI,OAAO,KAAK,KAAK,UAAU,EAAE,CAAC;QAChC,MAAM,IAAI,SAAS,CACjB,sEAAsE,CACvE,CAAA;IACH,CAAC;IAED,MAAM,qBAAqB,GACzB,cAAc,IAAI,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,SAAS,CAAA;IAErE,OAAO,KAAK,WAAW,GAAG,EAAE,IAAI;QAC9B,MAAM,IAAI,GAAG,OAAO,OAAO,KAAK,UAAU,CAAC,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,OAAO,CAAA;QAChE,MAAM,OAAO,GAAG,IAAI,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC,CAAA;QAElC,MAAM,OAAO,GAAG,IAAA,qBAAc,EAAC,IAAI,CAAC,OAAO,EAAE,qBAAqB,CAAC,CAAA;QAEnE,OAAO,KAAK,CAAC,OAAO,EAAE,EAAE,GAAG,IAAI,EAAE,OAAO,EAAE,CAAC,CAAA;IAC7C,CAAC,CAAA;AACH,CAAC","sourcesContent":["import { Gettable } from './types'\nimport { combineHeaders } from './util'\n\nexport type FetchHandler = (\n  this: void,\n  /**\n   * The URL (pathname + query parameters) to make the request to, without the\n   * origin. The origin (protocol, hostname, and port) must be added by this\n   * {@link FetchHandler}, typically based on authentication or other factors.\n   */\n  url: string,\n  init: RequestInit,\n) => Promise<Response>\n\nexport type FetchHandlerOptions = BuildFetchHandlerOptions | string | URL\n\nexport type BuildFetchHandlerOptions = {\n  /**\n   * The service URL to make requests to. This can be a string, URL, or a\n   * function that returns a string or URL. This is useful for dynamic URLs,\n   * such as a service URL that changes based on authentication.\n   */\n  service: Gettable<string | URL>\n\n  /**\n   * Headers to be added to every request. If a function is provided, it will be\n   * called on each request to get the headers. This is useful for dynamic\n   * headers, such as authentication tokens that may expire.\n   */\n  headers?: {\n    [_ in string]?: Gettable<null | string>\n  }\n\n  /**\n   * Bring your own fetch implementation. Typically useful for testing, logging,\n   * mocking, or adding retries, session management, signatures, proof of\n   * possession (DPoP), SSRF protection, etc. Defaults to the global `fetch`\n   * function.\n   */\n  fetch?: typeof globalThis.fetch\n}\n\nexport interface FetchHandlerObject {\n  fetchHandler: (\n    this: FetchHandlerObject,\n    /**\n     * The URL (pathname + query parameters) to make the request to, without the\n     * origin. The origin (protocol, hostname, and port) must be added by this\n     * {@link FetchHandler}, typically based on authentication or other factors.\n     */\n    url: string,\n    init: RequestInit,\n  ) => Promise<Response>\n}\n\nexport function buildFetchHandler(\n  options: FetchHandler | FetchHandlerObject | FetchHandlerOptions,\n): FetchHandler {\n  // Already a fetch handler (allowed for convenience)\n  if (typeof options === 'function') return options\n  if (typeof options === 'object' && 'fetchHandler' in options) {\n    return options.fetchHandler.bind(options)\n  }\n\n  const {\n    service,\n    headers: defaultHeaders = undefined,\n    fetch = globalThis.fetch,\n  } = typeof options === 'string' || options instanceof URL\n    ? { service: options }\n    : options\n\n  if (typeof fetch !== 'function') {\n    throw new TypeError(\n      'XrpcDispatcher requires fetch() to be available in your environment.',\n    )\n  }\n\n  const defaultHeadersEntries =\n    defaultHeaders != null ? Object.entries(defaultHeaders) : undefined\n\n  return async function (url, init) {\n    const base = typeof service === 'function' ? service() : service\n    const fullUrl = new URL(url, base)\n\n    const headers = combineHeaders(init.headers, defaultHeadersEntries)\n\n    return fetch(fullUrl, { ...init, headers })\n  }\n}\n"]}